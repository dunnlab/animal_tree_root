#!/bin/bash
mf=$(cat "${1:-/dev/stdin}")
testnexus=$(echo "$mf" | grep "#NEXUS")
	if [ "$testnexus" = "#NEXUS" ] ; then
		tempo=$(echo "$mf" | perl -pe "s@\[\&\!.+?\]\$@@g" )
	else
		txnames=$(echo "$mf" | head -n1 | egrep -o '[\(|,][^:\(\),]+' | perl -pe "s@\(|,@\t\'@g;s@\$@\'@")
		nextree=$(echo "$mf" | perl -pe "s@(:\d+\.\d{6})\d+@\1@g;
									s@\)([\d\./]+):@)[&BP=\"\1\"]:@g;
									s@([\(|,])([^:\(\),]+)@\1\'\2\'@g;
									s@\)(:[\d\.]+)\[(\d+)\]@\)[&BP=\2]\1@g")
		txcount=$(echo "$txnames" | wc -l | tr -d "\t")

		tempo=$(printf "#NEXUS\nbegin taxa;\n\tdimensions ntax=%s;\n\ttaxlabels\n%s\n;\nend;\n\nbegin trees;\n\ttree tree_1 = [&R] %s\nend;\n\nbegin figtree;\n\tset appearance.backgroundColorAttribute=\"Default\";\n\tset appearance.backgroundColour=#ffffff;\n\tset appearance.branchColorAttribute=\"User selection\";\n\tset appearance.branchColorGradient=false;\n\tset appearance.branchLineWidth=2.0;\n\tset appearance.branchMinLineWidth=0.0;\n\tset appearance.branchWidthAttribute=\"Fixed\";\n\tset appearance.foregroundColour=#000000;\n\tset appearance.hilightingGradient=false;\n\tset appearance.selectionColour=#3b5680;\n\tset branchLabels.colorAttribute=\"User selection\";\n\tset branchLabels.displayAttribute=\"BP\";\n\tset branchLabels.fontName=\"Helvatica\";\n\tset branchLabels.fontSize=10;\n\tset branchLabels.fontStyle=1;\n\tset branchLabels.isShown=true;\n\tset branchLabels.significantDigits=4;\n\tset layout.expansion=0;\n\tset layout.layoutType=\"RECTILINEAR\";\n\tset layout.zoom=0;\n\tset legend.attribute=\"BP\";\n\tset legend.fontSize=10.0;\n\tset legend.isShown=false;\n\tset legend.significantDigits=4;\n\tset nodeBars.barWidth=4.0;\n\tset nodeBars.displayAttribute=null;\n\tset nodeBars.isShown=false;\n\tset nodeLabels.colorAttribute=\"User selection\";\n\tset nodeLabels.displayAttribute=\"Node ages\";\n\tset nodeLabels.fontName=\"SansSerif\";\n\tset nodeLabels.fontSize=8;\n\tset nodeLabels.fontStyle=0;\n\tset nodeLabels.isShown=false;\n\tset nodeLabels.significantDigits=4;\n\tset nodeShapeExternal.colourAttribute=\"User selection\";\n\tset nodeShapeExternal.isShown=false;\n\tset nodeShapeExternal.minSize=10.0;\n\tset nodeShapeExternal.scaleType=Width;\n\tset nodeShapeExternal.shapeType=Circle;\n\tset nodeShapeExternal.size=4.0;\n\tset nodeShapeExternal.sizeAttribute=\"Fixed\";\n\tset nodeShapeInternal.colourAttribute=\"User selection\";\n\tset nodeShapeInternal.isShown=false;\n\tset nodeShapeInternal.minSize=10.0;\n\tset nodeShapeInternal.scaleType=Width;\n\tset nodeShapeInternal.shapeType=Circle;\n\tset nodeShapeInternal.size=4.0;\n\tset nodeShapeInternal.sizeAttribute=\"Fixed\";\n\tset polarLayout.alignTipLabels=false;\n\tset polarLayout.angularRange=0;\n\tset polarLayout.rootAngle=0;\n\tset polarLayout.rootLength=100;\n\tset polarLayout.showRoot=true;\n\tset radialLayout.spread=0.0;\n\tset rectilinearLayout.alignTipLabels=false;\n\tset rectilinearLayout.curvature=0;\n\tset rectilinearLayout.rootLength=100;\n\tset scale.offsetAge=0.0;\n\tset scale.rootAge=1.0;\n\tset scale.scaleFactor=1.0;\n\tset scale.scaleRoot=false;\n\tset scaleAxis.automaticScale=true;\n\tset scaleAxis.fontSize=11.0;\n\tset scaleAxis.isShown=false;\n\tset scaleAxis.lineWidth=1.0;\n\tset scaleAxis.majorTicks=1.0;\n\tset scaleAxis.minorTicks=0.5;\n\tset scaleAxis.origin=0.0;\n\tset scaleAxis.reverseAxis=false;\n\tset scaleAxis.showGrid=true;\n\tset scaleBar.automaticScale=true;\n\tset scaleBar.fontSize=11.0;\n\tset scaleBar.isShown=true;\n\tset scaleBar.lineWidth=1.0;\n\tset scaleBar.scaleRange=0.0;\n\tset tipLabels.colorAttribute=\"User selection\";\n\tset tipLabels.displayAttribute=\"Names\";\n\tset tipLabels.fontName=\"Times\";\n\tset tipLabels.fontSize=14;\n\tset tipLabels.fontStyle=0;\n\tset tipLabels.isShown=true;\n\tset tipLabels.significantDigits=4;\n\tset trees.order=true;\n\tset trees.orderType=\"increasing\";\n\tset trees.rooting=true;\n\tset trees.rootingType=\"Midpoint\";\n\tset trees.transform=false;\n\tset trees.transformType=\"cladogram\";\nend;\n\n" "$txcount" "$txnames" "$nextree")

	fi

amAM='\[&!color=#6699ff\]'
amCF='\[&!color=#0000ff\]'
amFU='\[&!color=#0080ff\]'
amME='\[&!color=#0000ff\]'
amHO='\[&!color=#0000ff\]'
amPU='\[&!color=#6d8ace\]'
apML='\[&!color=#0099cc\]'
apAN='\[&!color=#8db0a0\]'
arAS='\[&!color=#800040\]'
arDP='\[&!color=#800080\]'
arEU='\[&!color=#400080\]'
arTC='\[&!color=#9c41c2\]'
diAL='\[&!color=#4c7e00\]'
diCH='\[&!color=#00d904\]'
diCR='\[&!color=#dbb700\]'
diGL='\[&!color=#00b27d\]'
diHA='\[&!color=#d69d00\]'
diHP='\[&!color=#d69d00\]'
diKR='\[&!color=#ba7e06\]'
diPL='\[&!color=#00a811\]'
diRP='\[&!color=#62b800\]'
diRZ='\[&!color=#007e7d\]'
diST='\[&!color=#83a100\]'
exEG='\[&!color=#ff7847\]'
exFR='\[&!color=#ff0080\]'
exHL='\[&!color=#ff306e\]'
exJA='\[&!color=#ff57ee\]'
exPB='\[&!color=#ff00ff\]'
exTX='\[&!color=#ff0000\]'
baXX='\[&!color=#4c4c4c\]'
baCN='\[&!color=#999999\]'
baAP='\[&!color=#999999\]'
baXX='\[&!color=#4c4c4c\]'
baCN='\[&!color=#999999\]'
baAP='\[&!color=#999999\]'
amAMArch='\[&!color=#6699ff\]'
amAMCent='\[&!color=#999900\]'
amAMCory='\[&!color=#339900\]'
amAMCuto='\[&!color=#6699ff\]'
amAMEchi='\[&!color=#339900\]'
amAMElar='\[&!color=#339900\]'
amAMEumy='\[&!color=#6699ff\]'
amAMFlab='\[&!color=#999900\]'
amAMVari='\[&!color=#6699ff\]'

perl -pe "s@(^\t'?am-AM.+)@\1$amAM@;
s@(^\t'?am-CF.+)@\1$amCF@;
s@(^\t'?am-FU.+)@\1$amFU@;
s@(^\t'?am-ME.+)@\1$amME@;
s@(^\t'?am-HO.+)@\1$amHO@;
s@(^\t'?am-PU.+)@\1$amPU@;
s@(^\t'?ap-ML.+)@\1$apML@;
s@(^\t'?ap-AN.+)@\1$apAN@;
s@(^\t'?ar-AS.+)@\1$arAS@;
s@(^\t'?ar-DP.+)@\1$arDP@;
s@(^\t'?ar-EU.+)@\1$arEU@;
s@(^\t'?ar-TC.+)@\1$arTC@;
s@(^\t'?di-AL.+)@\1$diAL@;
s@(^\t'?di-CH.+)@\1$diCH@;
s@(^\t'?di-CR.+)@\1$diCR@;
s@(^\t'?di-GL.+)@\1$diGL@;
s@(^\t'?di-HA.+)@\1$diHA@;
s@(^\t'?di-HP.+)@\1$diHP@;
s@(^\t'?di-KR.+)@\1$diKR@;
s@(^\t'?di-PL.+)@\1$diPL@;
s@(^\t'?di-RP.+)@\1$diRP@;
s@(^\t'?di-RZ.+)@\1$diRZ@;
s@(^\t'?di-ST.+)@\1$diST@;
s@(^\t'?ex-EG.+)@\1$exEG@;
s@(^\t'?ex-FR.+)@\1$exFR@;
s@(^\t'?ex-HL.+)@\1$exHL@;
s@(^\t'?ex-JA.+)@\1$exJA@;
s@(^\t'?ex-PB.+)@\1$exPB@;
s@(^\t'?ex-TX.+)@\1$exTX@;
s@(^\t'?ba-\w\w.+)@\1$baXX@;
s@(^\t'?ba-CN.+)@\1$baCN@;
s@(^\t'?ba-AP.+)@\1$baAP@;
s@(^\t'?ub-\w\w.+)@\1$ubXX@;
s@(^\t'?ub-CN.+)@\1$ubCN@;
s@(^\t'?ub-AP.+)@\1$ubAP@;
s@(^\t'?am-AM_Arch.+)@\1$amAMArch@;
s@(^\t'?am-AM_Cuto.+)@\1$amAMCuto@;
s@(^\t'?am-AM_Eumy.+)@\1$amAMEumy@;
s@(^\t'?am-AM_Vari.+)@\1$amAMVari@;
s@(^\t'?am-AM_Cent.+)@\1$amAMCent@;
s@(^\t'?am-AM_Flab.+)@\1$amAMFlab@;
s@(^\t'?am-AM_Cory.+)@\1$amAMCory@;
s@(^\t'?am-AM_Echi.+)@\1$amAMEchi@;
s@(^\t'?am-AM_Elar.+)@\1$amAMElar@ " <(echo "$tempo")




			
